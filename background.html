<html><head></head>
<body>
<script src="lib/underscore-1.3.1.min.js"></script>
<script src="lib/omni.js"></script>

<script>
  //map of tabid => context id
  var tabmap = {};

  var mostRecentTabId;
  chrome.tabs.onActiveChanged.addListener(function(tabid, selectinfo){
    mostRecentTabId = tabid;
  });

  chrome.extension.onConnect.addListener(function(port){
    console.log('connection made!!!');

    port.onMessage.addListener(function(msg){
      console.log('msg from client: ', msg);
      tabmap[mostRecentTabId] = msg;
    });
  });

  var oldurl = '';
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    console.log('updated', arguments)

    var ctxTitle = tabmap[tabId],
        newurl = tab.url;

    if(newurl == oldurl || !ctxTitle) return;
    oldurl = newurl;

    var context = omni.Contexts.get(ctxTitle);

    if(_.find(context.urls, function(){ return newurl })) {
      console.log('url is already tracked. returning');
      return;
    }

    console.log('adding url', newurl, 'to context', context.title)
    context.urls.push(newurl)
    context.save();
  });

</script>

</body>
</html>
