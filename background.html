<html><head></head>
<body>
<script src="lib/underscore-1.3.1.min.js"></script>
<script src="lib/omni.js"></script>

<script>
  //map of tabid => context id
  var tabmap = {};

  chrome.extension.onConnect.addListener(function(port){
    port.onMessage.addListener(function(msg){
      console.log('msg from client: ', msg);
      if(!msg.type || !msg.tabid) throw "invalid message";

      tabmap[msg.tabid] = msg.contextId;
      console.log('context', msg.contextId, 'is now paired with tab', msg.tabid);
    });
  });

  var oldurl = '';
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    var ctxTitle = tabmap[tabId],
        newurl = tab.url;

    if(newurl == oldurl) return;
    oldurl = newurl;

    if(!omni.Contexts.has(ctxTitle)) {
      console.log('no context is set for the current title');
      return;
    }

    var context = omni.Contexts.get(ctxTitle);

    if(_.find(context.urls, function(){ return newurl })) {
      console.log('url is already tracked. returning');
      return;
    }

    console.log('adding url', newurl, 'to context', context.title)
    context.urls.push(newurl)
    context.save();
  });

</script>

</body>
</html>
