<html><head></head>
<body>
<script src="lib/underscore-1.3.1.min.js"></script>
<script src="lib/underscore-1.3.1.min.js"></script>

<script>

  /**
   * This is a place for doing local-storage based settings, init, etc.
   */

  if(!localStorage['initted']) {
    alert("what up, dawg? looks like you're initting for the first time");
    alert("don't worry-- you should only see this message when you first install extension");
    localStorage['initted'] = true;
  }

</script>
<script>

  console.log('BACKGROUND PAGE LOGS:')

  chrome.extension.onConnect.addListener(function(port){
    port.onMessage.addListener(function(msg){
      console.log('msg from client: ', msg);
      port.postMessage('ack')
    })
  })

</script>

<script>

  var omni = {};

  /**
   * Serializer -- tries to save every 100ms (if there are any changes to save, that is)
   */

  var createSerializer = function(key, getFn){ 

    var serializer = {},
        dirty = false,
        data;

    if(key in localStorage) {
      console.log('key', key, 'found in localStorage. loading data.');
    } else {
      console.log('key', key, 'not found in localStorage');
      localStorage[key] = '{}';
    }

    data = JSON.parse(localStorage[key]);

    setTimeout(function serialize(){
      setTimeout(serialize, 100);

      if(!dirty) return;
      dirty = false;

      localStorage[key] = JSON.stringify(getFn());
      console.log('flushed data', data, 'for key', key);
    });

    return {
      data: data,
      markDirty: function(){ dirty = true }
    };
  };


  /**
   * note storage / management / caching
   */

  (function(Contexts){

    function Context(id, tags, text) {
      this.notes = [];
      this.urls = [];
      this.id = id;
      this.tags = tags;
      this.text = text;
    }

    if(!'omni-cid' in localStorage) localStorage['omni-cid'] = 0;
    function nextCid(){ return localStorage['omni-cid']++ }

    var tagmap = {};

    Contexts.get = function(tags) {
      return contexts[id];
    }

    Contexts.getAll = function() {
      return _.values(contexts).sort(function(a,b){ return a.id - b.id });
    }

    Contexts.search = function(query) {
      return [];
    }

    var serializer = createSerializer('omni-contexts', Contexts.getAll);
    if(!localStorage['omni-cid']) localStorage['omni-cid'] = 0;

    var contexts = serializer.data;

    Contexts.create = function(tags, text){
      var newid = nextCid(),
          newctx = contexts[newid] = new Context(newid, tags, text);

      _(newctx.tags).each(function(tag){
        if(!tagmap[tag]) tagmap[tag] = [];
        tagmap[tag].push(newctx)
      });

      serializer.markDirty();

      return newctx;
    }

  })(omni.Contexts = {});

</script>

</body>
</html>
